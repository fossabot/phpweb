---
layout:         post
title:          专线开通全流程辅助工具
date:           2017-12-17 20:24:02
summary:        记录需求，开发思路等
categories:     notes
update_date:    2018-1-9 03:40:24
---

## 工作流程(to be writen)



## 功能模块

### 专线申请

输入客户信息，输入自己的 姓名、邮箱。分配好ip、vlan后会回复邮件。

### IP/VLAN 查询

```
仅可查看自己申请的ip、vlan信息。
每次查询需发送邮箱验证码。有效期12小时
```

基本信息显示

- 上一次分配的IP
- 申请IP待办数量（争取自动化）
- 预分配、流程未到的数据数量
- 流程已走，待做数据的数量。

全局搜索

- 根据列输入关键字
- 显示结果用handsontable

### 信息修改

管理员查询、修改。

TODO：

- 调整数据转化成可直接生成数据制作脚本的格式
- 测试handsontable多条数据修改，能否检测修改的数据信息

### 流程录入信息生成



### 数据制作脚本生成



### *查询vlan是否已分配

基于`infotables`的a端基站(汉字)搜索vlan；如不存在，继续基于`vlantables`的9312设备名搜索vlan。若a

端基站转换成9312设备名失败，则提示A端基站有误！否则返回查询结果（结果为空，即未分配）


## 数据结构

根据实际需求，数据产生的先后顺序，设计如下几张数据表：

### IP表

> 预先根据可分配ip，录入好IP信息表，主要字段有：
> id、ip、mask、ifUse、ipType
>
> IP地址存储类型：int 
> 1. 利用MySQL函数进行处理。可以采用INET_ATON，INET_NTOA函数进行转换。
> 2. 利用开发语言的函数进行处理，以php进行举例。可以采用ip2long，long2ip函数进行转换。

单独记录IP是为了自动分配IP时做判断

```php
# PHP存入时：
$ip = ip2long($ip);
# MySQLl取出时：
SELECT INET_ATON(ip) FROM table 
# PHP取出时，多一步：
$ip = long2ip($ip);
```

### vlan表

> 同一台交换机内vlan不可重复，主要字段有：
> id、deviceName、vlan、description

### 申请信息表

> 申请开通时提供的信息，基于模板excel表格，都是必填项。
> 其中：aStation、zxType、cProperty为枚举值。以及附带的oltName
> 新增字段：
> ifOnu、oltName、id、aPerson、aEmail、status、tags
> 额外字段：extra（IP备案用）json格式

| 序号   | 字段名         | 注释      | 类型/大小              |
| ---- | ----------- | ------- | ------------------ |
| 0    | aDate       | 申请时间    | DATE               |
| 1    | instanceId  | 产品实例标识  | BIGINT(11)         |
| 2    | zxType      | 专线类别    | VARCHAR(15)        |
| 3    | bandWidth   | 带宽      | INT(3)             |
| 4    | neFactory   | 网元厂家    | INT(1)             |
| 5    | aStation    | A端基站    | VARCHAR(15)        |
| 6    | cName       | 客户名     | VARCHAR(90)        |
| 7    | cAddress    | 客户地址    | VARCHAR(180)       |
| 8    | cNeeds      | 客户需求    | VARCHAR(450)       |
| 9    | vlan        | vlanId  | INT                |
| 10   | ip          | 互联ipId  | INT                |
| 11   | cPersion    | 客户联系人姓名 | VARCHAR(15)        |
| 12   | cPhone      | 客户联系人电话 | VARCHAR(12)        |
| 13   | cEmail      | 客户联系人邮箱 | VARCHAR(40)        |
| 14   | mPerson     | 客户经理姓名  | VARCHAR(15)        |
| 15   | mPhone      | 客户经理电话  | VARCHAR(12)        |
| 16   | mEmail      | 客户经理邮箱  | VARCHAR(40)        |
| 17   | cProperty   | 单位性质    | VARCHAR(12)        |
| 18   | marks       | 备注      | VARCHAR(300)       |
| 19   | ipB         | 业务ipId  | INT                |
| 20   | ifOnu       | 是否走onu  | INT(1)             |
| 21   | oltName     | olt名称   | VARCHAR(150)       |
| 22   | id          | id      | INT AUTO_INCREMENT |
| 23   | aPerson     | 信息申请人   | VARCHAR(30)        |
| 24   | aEmail      | 信息申请人邮箱 | VARCHAR(40)        |
| 25   | create_time | 创建时间    | INT                |
| 26   | update_time | 更新时间    | INT                |
| 27   | status      | 状态      | INT(1)             |
| 28   | tags        | 标签      | VARCHAR(50)        |
| 29   | extra       | 额外数据    | VARCHAR(750)       |

## 功能逻辑

###　登陆

- 根据邮箱验证码登录，基于 localStorage 保存会话。有效期15天
- 登陆判断权限，跳转至对应页面

### 用户-申请

- 填写信息，数据校验后可提交。


- 默认状态为待分配，根据ip表上次分配的ip，自动预分配下一个未使用的ip，vlan同理。手动预分配确认，则发送邮件到申请者。
- 登陆状态使用`LocalStorage`保存，有效期内免验证登陆。并直接跳回登陆前页面。

### 用户-信息查询

- 基于邮箱筛选，仅可查看/修改自己邮箱申请过的信息。其他查询需使用邮箱验证码。并验证邮箱是否有权限自主查询数据。将查询操作记录日志。

### 管理-待办

- 显示申请后未自动分配的列表。点击显示详细信息，内容均可修改，填写ip、vlan后可提交
- ip录入格式：`xxx.xxx.xxx.xxx[/mask]`，如：`223.100.100.100`或`172.16.32.24/30`


- 提交时更新数据表`infotables`。并返回提交结果和最新的待办列表
- 提交时自动判断录入的ip、vlan是否重复，重复则返回失败的提示，并自动关联入`vlantables`

### 管理-导入历史数据

- 导入历史数据 （强校验）
  - 根据模板复制粘贴（可多条）
  - 单条填表录入（暂不支持，可使用`用户-申请ip、vlan`代替）

### 管理-查询

- 展示台账，可全局模糊搜索

  > 仅`客户名`、`产品示例标识`、`vlan`列


- 点击单条台账，显示详细信息

- 直接编辑台账信息，提示是否同步至服务器的确认对话框，此设置当前回话内有效。

  > 此处修改时不做数据冲突验证，需注意

- 右键打开编辑页，修改台账信息，提交时处理逻辑与代办提交类似，验证数据规范，并在修改vlan时联动修改`vlantables`。

- 右键点击台账，可生成数据制作脚本、导出资管/IP备案的模板数据等操作。

  > 生成数据制作脚本，显示脚本窗口。  
  > 导出模板，直接返回excel下载。


- 右键可显示/隐藏台账状态(背景色)功能

  ​

### 管理-设置

- 更新最后一次分配的ip
- 更新录入sw交换机的已分配vlan。如已存在则忽略

### 需求分析

- 不需要显示所有信息，查询可由服务器完成。全局查询或导出全部台账为excel下载后手动查询。
- 数据呈现与数据存储格式不一致，存储格式可扩展，前后端数据同步操作需**额外开销**。
- 显示带有不同**标签**的数据的数量，点击显示详细条目信息。
- 需一眼看出分配到哪个IP了
- 独立的vlan预分配记录表
- 数据表设计字段类型需考虑历史数据迁移问题
  方案1：数据表字段类型不严格限制，均为varchar。  
  方案2：设计两张数据表，保存旧数据的采用方案1设计，新数据符合规范，严格设置字段类型及大小。  
  方案3：按照新数据严格限制，历史数据迁移前整改历史数据的数据规范，直至符合数据规范。

若方案1，查询搜索方便，但性能有损。前端严格验证，数据格式、数据安全不可控。  
若方案2，新数据格式规范无隐患，且便于将来大数据分析。 但查询需指定数据表，设计复杂， 
若方案3，最优方案，整改耗时耗力。

### 使用场景涉及的操作备忘录

##### 预分配ip、vlan--manage/todo

`Manage/todo()、checkInstanceId()、checkAndSetIp()、checkAndSetVlan()`

##### 查询页面生成制作脚本--manage/query

`Tool/_script.html、Magage/_getDevice9312Info()`

##### 查询页面修改信息--manage/query

`Manage/query()、queryUpdateInfo()`

##### 管理-导入历史数据--manage/import

`Manage/import()、_ht_apply()、checkDateIsValid()`

## TODO

1. 背景色区分状态（历史数据导入、代办、预分配、ip已录已备案、已做数据）